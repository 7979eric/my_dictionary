<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¼ë¬¸ ë¦¬ë”©ìš© ë‹¨ì–´ì¥ Pro</title>
    <style>
        :root {
            --primary-medical: #2c7be5;
            --bg-medical: #f0f7ff;
            --primary-general: #00d97e;
            --bg-general: #f2fff9;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
            --highlight-red: #e74c3c;
            --danger-color: #dc3545;
        }
        body {
            font-family: 'Pretendard', -apple-system, system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container { width: 100%; max-width: 800px; }
        h1 { text-align: center; color: #333; margin-bottom: 1.5rem; font-size: 1.6rem; }
        
        .data-controls { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px; }
        .data-btn {
            background-color: #fff; border: 1px solid #ccc; padding: 6px 12px;
            border-radius: 6px; font-size: 0.8rem; cursor: pointer; color: #555;
            transition: all 0.2s;
        }
        .data-btn:hover { background-color: #f0f0f0; border-color: #999; }
        .data-btn.danger { color: var(--danger-color); border-color: #f5c6cb; }

        .tabs { display: flex; background: #e0e0e0; border-radius: var(--border-radius); padding: 4px; margin-bottom: 15px; }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: transparent;
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; color: #666;
        }
        .tab-btn.active[data-tab="medical"] { background: white; color: var(--primary-medical); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-btn.active[data-tab="general"] { background: white; color: var(--primary-general); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .input-card {
            background: var(--card-bg); padding: 1.5rem; border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 2rem;
        }
        .mode-selector { display: flex; gap: 5px; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .mode-btn {
            padding: 4px 10px; font-size: 0.75rem; border: 1px solid #ddd; background: #f9f9f9;
            border-radius: 4px; cursor: pointer; color: #777;
        }
        .mode-btn.active { background: #666; color: white; border-color: #666; }

        .input-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        input, textarea, select {
            padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; font-family: inherit;
        }
        textarea { width: 100%; box-sizing: border-box; resize: vertical; min-height: 50px; }
        
        .bulk-guide { 
            font-size: 0.8rem; color: #555; margin-bottom: 8px; padding: 12px; 
            background: #fff9db; border-radius: 6px; border: 1px solid #fab005; 
            line-height: 1.6;
        }

        .btn-group { display: flex; gap: 8px; margin-top: 15px; }
        .primary-btn {
            flex: 2; background-color: var(--primary-medical); color: white; border: none;
            padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;
        }
        #cancel-btn { flex: 1; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; display: none; }

        .search-container { 
            display: flex; gap: 8px; margin-bottom: 20px; background: #fff; 
            padding: 8px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            align-items: center;
        }
        .search-select { width: 150px; flex-shrink: 0; border: 1px solid #ddd; cursor: pointer; background: #f8f9fa; height: 42px; }
        .search-wrapper { position: relative; flex: 1; display: flex; align-items: center; }
        .search-input { width: 100%; border: 1px solid #ddd; padding: 10px 35px 10px 10px; border-radius: 8px; height: 42px; box-sizing: border-box; }
        .search-clear { position: absolute; right: 10px; cursor: pointer; color: #ccc; font-size: 18px; display: none; user-select: none; }
        .search-clear:hover { color: #666; }

        .vocab-list { list-style: none; padding: 0; display: grid; gap: 12px; }
        .vocab-item { padding: 1.2rem; border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); position: relative; border: 1px solid transparent; }
        .vocab-item.item-medical { background-color: var(--bg-medical); border-color: #d0e4ff; }
        .vocab-item.item-medical .word { color: var(--primary-medical); }
        .vocab-item.item-general { background-color: var(--bg-general); border-color: #d6f5e8; }
        .vocab-item.item-general .word { color: #009e5c; }

        .cat-badge { display: inline-block; font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; margin-bottom: 8px; font-weight: bold; color: white; }
        .item-medical .cat-badge { background: var(--primary-medical); }
        .item-general .cat-badge { background: var(--primary-general); }

        .word-group { display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap; }
        .word { font-size: 1.3rem; font-weight: 800; }
        .pronunciation { font-size: 0.95rem; color: #2c7be5; font-style: italic; margin-right: 5px; }
        .meaning { font-size: 1.05rem; color: #333; font-weight: 600; }
        
        .emphasis { color: var(--highlight-red); font-weight: 800; text-decoration: underline; }
        .deriv-text { font-size: 0.85rem; color: #666; margin-top: 4px; font-style: italic; }
        
        .example-box { background: rgba(255, 255, 255, 0.6); padding: 10px; border-radius: 6px; font-size: 0.9rem; margin-top: 8px; border-left: 3px solid #ddd; line-height: 1.5; color: #444; white-space: pre-wrap; word-break: break-all; }
        .supp-box { background: rgba(0, 0, 0, 0.04); padding: 10px; border-radius: 6px; font-size: 0.85rem; margin-top: 5px; border-left: 3px solid #6c757d; color: #555; white-space: pre-wrap; word-break: break-all; }
        
        .action-btns { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; }
        .icon-btn { background: transparent; border: none; cursor: pointer; font-size: 0.95rem; color: #999; }
        .icon-btn:hover { color: #666; }
        /* ê´€ì‹¬ ë‹¨ì–´(â­) */
        .icon-btn.star-btn { font-size: 1.05rem; }
        .icon-btn.star-btn.on { color: #f5a623; }

        .tab-btn.active[data-tab="star"] { background: white; color: #f5a623; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* ê´€ì‹¬ ë‹¨ì–´ í¸ì§‘ ëª¨ë‹¬ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 999; }
        .modal.open { display: flex; }
        .modal-content {
            width: 100%; max-width: 720px; background: #fff; border-radius: 14px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.18); overflow: hidden;
        }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid #eee; }
        .modal-header h2 { margin: 0; font-size: 1.05rem; }
        .modal-close { border: none; background: transparent; cursor: pointer; font-size: 1.4rem; color: #999; line-height: 1; }
        .modal-close:hover { color: #666; }
        .modal-actions { display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid #f1f1f1; align-items: center; }
        .modal-search { flex: 1; height: 40px; }
        .star-list { list-style: none; padding: 12px 16px; margin: 0; display: grid; gap: 8px; max-height: 60vh; overflow: auto; }
        .star-row { display: flex; gap: 10px; align-items: center; border: 1px solid #eee; border-radius: 10px; padding: 10px 12px; }
        .star-row .star-meta { flex: 1; min-width: 0; }
        .star-row .star-word { font-weight: 800; }
        .star-row .star-meaning { color: #555; margin-left: 6px; font-weight: 600; }
        .star-row .star-sub { font-size: 0.8rem; color: #777; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .star-row .star-ctrl { display: flex; gap: 6px; }
        .mini-btn { border: 1px solid #ddd; background: #fff; border-radius: 8px; padding: 6px 8px; cursor: pointer; font-size: 0.85rem; color: #555; }
        .mini-btn:hover { background: #f6f6f6; }
        .mini-btn.danger { border-color: #f5c6cb; color: var(--danger-color); }
        .modal-footer { padding: 10px 16px 14px 16px; border-top: 1px solid #f1f1f1; color: #777; font-size: 0.8rem; }

    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“š ë…¼ë¬¸ ë¦¬ë”©ìš© ë‹¨ì–´ì¥ Pro</h1>
    
    <div class="data-controls">
        <button id="delete-all-btn" class="data-btn danger">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
        <button id="export-btn" class="data-btn">ğŸ“¤ ë°±ì—…</button>
        <button id="import-btn" class="data-btn">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="star-manage-btn" class="data-btn">â­ ê´€ì‹¬ ë‹¨ì–´</button>
        <input type="file" id="file-input" style="display: none;" accept=".json">
    </div>

    <div class="tabs">
        <button class="tab-btn active" data-tab="medical" onclick="switchTab('medical')">ğŸ¥ ì˜í•™ ìš©ì–´</button>
        <button class="tab-btn" data-tab="general" onclick="switchTab('general')">ğŸ ì¼ë°˜ ì˜ë‹¨ì–´</button>
        <button class="tab-btn" data-tab="star" onclick="switchTab('star')">â­ ê´€ì‹¬ ë‹¨ì–´</button>
    </div>

    <div class="input-card">
        <div class="mode-selector">
            <button class="mode-btn active" id="mode-indiv" onclick="switchMode('individual')">ê°œë³„ ì…ë ¥</button>
            <button class="mode-btn" id="mode-bulk" onclick="switchMode('bulk')">ì¼ê´„ íŒŒì‹±</button>
        </div>

        <div id="individual-area">
            <div class="input-row">
                <select id="category-select" style="width: 110px;">
                    <option value="medical">ì˜í•™ ìš©ì–´</option>
                    <option value="general">ì¼ë°˜ ë‹¨ì–´</option>
                </select>
                <input type="text" id="word-input" placeholder="ë‹¨ì–´" style="flex:1">
                <input type="text" id="pronunciation-input" placeholder="ë°œìŒ" style="flex:1">
            </div>
            <div class="input-row">
                <input type="text" id="meaning-input" placeholder="ëœ»" style="flex:1">
                <input type="text" id="derivative-input" placeholder="íŒŒìƒì–´" style="flex:1">
            </div>
            <textarea id="example-input" placeholder="ì˜ˆì‹œ (ì¤„ë°”ê¿ˆ ë° ==ê°•ì¡°== ì ìš© ê°€ëŠ¥)"></textarea>
            <textarea id="supplement-input" placeholder="ë³´ì¶© ì„¤ëª… (ì˜í•™ ì „ìš©)"></textarea>
        </div>

        <div id="bulk-area" style="display:none;">
            <div id="bulk-guide-text" class="bulk-guide"></div>
            <textarea id="bulk-input" style="min-height:120px;" placeholder="ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        </div>

        <div class="btn-group">
            <button id="add-btn" class="primary-btn">ì¶”ê°€í•˜ê¸°</button>
            <button id="cancel-btn">ì·¨ì†Œ</button>
        </div>
    </div>

    <div class="search-container">
        <select id="search-target" class="search-select">
            <option value="all">ğŸ” ì „ì²´ ì°¾ê¸°</option>
            <option value="word">ë‹¨ì–´(íŒŒìƒì–´)</option>
            <option value="meaning">ëœ»</option>
            <option value="supp">ë³´ì¶© ì„¤ëª…</option>
        </select>
        <div class="search-wrapper">
            <input type="text" id="search-input" class="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <span id="search-clear" class="search-clear" title="ê²€ìƒ‰ ì´ˆê¸°í™”">Ã—</span>
        </div>
    </div>

    <ul id="vocab-list" class="vocab-list"></ul>

    <!-- â­ ê´€ì‹¬ ë‹¨ì–´ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="star-modal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-label="ê´€ì‹¬ ë‹¨ì–´ í¸ì§‘">
            <div class="modal-header">
                <h2>â­ ê´€ì‹¬ ë‹¨ì–´ í¸ì§‘</h2>
                <button id="star-modal-close" class="modal-close" title="ë‹«ê¸°">Ã—</button>
            </div>
            <div class="modal-actions">
                <input type="text" id="star-modal-search" class="modal-search" placeholder="ê´€ì‹¬ ë‹¨ì–´ ê²€ìƒ‰...">
                <button id="star-clear-btn" class="data-btn danger" title="ê´€ì‹¬ ë‹¨ì–´ ì „ì²´ í•´ì œ">ì „ì²´ í•´ì œ</button>
            </div>
            <ul id="star-list" class="star-list"></ul>
            <div class="modal-footer">ìˆœì„œ ë³€ê²½: â–²â–¼ ë²„íŠ¼ / ì‚­ì œ: âœ– ë²„íŠ¼</div>
        </div>
    </div>

</div>

<script>
    let vocabData = JSON.parse(localStorage.getItem('studyVocabData')) || [];
    let starOrder = JSON.parse(localStorage.getItem('studyVocabStarOrder')) || [];

    // ë§ˆì´ê·¸ë ˆì´ì…˜: ë°±ì—… JSONì— starredê°€ í¬í•¨ë˜ì–´ ìˆê³ , ë³„ë„ ìˆœì„œ ë°ì´í„°ê°€ ì—†ì„ ë•Œ
    if (starOrder.length === 0) {
        starOrder = vocabData.filter(i => i && i.starred).map(i => i.id);
    }

    let currentTab = 'medical';
    let currentMode = 'individual';
    let editingId = null;

    const wordInput = document.getElementById('word-input'),
          pronunciationInput = document.getElementById('pronunciation-input'),
          meaningInput = document.getElementById('meaning-input'),
          derivativeInput = document.getElementById('derivative-input'),
          exampleInput = document.getElementById('example-input'),
          supplementInput = document.getElementById('supplement-input'),
          bulkInput = document.getElementById('bulk-input'),
          bulkGuideText = document.getElementById('bulk-guide-text'),
          categorySelect = document.getElementById('category-select'),
          addBtn = document.getElementById('add-btn'),
          cancelBtn = document.getElementById('cancel-btn'),
          vocabList = document.getElementById('vocab-list'),
          searchInput = document.getElementById('search-input'),
          searchClear = document.getElementById('search-clear'),
          searchTarget = document.getElementById('search-target'),
          exportBtn = document.getElementById('export-btn'),
          importBtn = document.getElementById('import-btn'),
          deleteAllBtn = document.getElementById('delete-all-btn'),
          fileInput = document.getElementById('file-input'),
          starManageBtn = document.getElementById('star-manage-btn'),
          starModal = document.getElementById('star-modal'),
          starModalClose = document.getElementById('star-modal-close'),
          starListEl = document.getElementById('star-list'),
          starClearBtn = document.getElementById('star-clear-btn'),
          starModalSearch = document.getElementById('star-modal-search');

    function normalize(s) { return (s || '').trim().toLowerCase(); }

    function findDuplicate(word, category) {
        return vocabData.find(existing =>
            normalize(existing.word) === normalize(word) &&
            existing.category === category
        );
    }
    function checkDuplicate(word, category) { return !!findDuplicate(word, category); }

    function isStarred(id) { return starOrder.includes(id); }
    function addStar(id, toTop = true) {
        if (isStarred(id)) return;
        toTop ? starOrder.unshift(id) : starOrder.push(id);
    }
    function removeStar(id) { starOrder = starOrder.filter(x => x !== id); }

    function pruneStarOrder() {
        const ids = new Set(vocabData.map(i => i.id));
        starOrder = starOrder.filter(id => ids.has(id));
    }
    function syncStarFlags() {
        const set = new Set(starOrder);
        vocabData = vocabData.map(i => ({ ...i, starred: set.has(i.id) }));
    }

    function saveAndRender() {
        pruneStarOrder();
        syncStarFlags();
        localStorage.setItem('studyVocabData', JSON.stringify(vocabData));
        localStorage.setItem('studyVocabStarOrder', JSON.stringify(starOrder));
        renderList();
        renderStarManager(); // ëª¨ë‹¬ì´ ì—´ë ¤ ìˆì§€ ì•Šì•„ë„ ì•ˆì „
    }

    // ===== ë°ì´í„° ê´€ë¦¬ =====
    deleteAllBtn.addEventListener('click', () => {
        if (vocabData.length === 0) { alert("ì‚­ì œí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        if (confirm("ëª¨ë“  ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            if (confirm("ë§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.")) {
                vocabData = [];
                starOrder = [];
                saveAndRender();
                alert("ëª¨ë“  ë‹¨ì–´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }
    });

    exportBtn.addEventListener('click', () => {
        if (vocabData.length === 0) { alert("ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
        pruneStarOrder(); syncStarFlags();
        const dataStr = JSON.stringify(vocabData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const now = new Date();
        const timestamp = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + '_' + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0') + String(now.getSeconds()).padStart(2, '0');
        const a = document.createElement('a'); a.href = url; a.download = `vocab_backup_${timestamp}.json`; a.click(); URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (!Array.isArray(importedData)) throw new Error("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

                let addedCount = 0; let skipCount = 0; let starredApplied = 0;

                importedData.forEach(newItem => {
                    if (!newItem || !newItem.word || !newItem.meaning || !newItem.category) return;

                    const dup = findDuplicate(newItem.word, newItem.category);

                    // ì¤‘ë³µì´ë©´ ê¸°ì¡´ ì•„ì´í…œì— ê´€ì‹¬(â­)ë§Œ ë°˜ì˜í•  ìˆ˜ ìˆê²Œ ì²˜ë¦¬
                    if (dup) {
                        if (newItem.starred) { addStar(dup.id, false); starredApplied++; }
                        skipCount++;
                        return;
                    }

                    const id = newItem.id || (Date.now() + Math.random());
                    const item = {
                        id,
                        word: newItem.word,
                        meaning: newItem.meaning,
                        pronunciation: newItem.pronunciation || '',
                        derivative: newItem.derivative || '',
                        example: newItem.example || '',
                        supplement: (newItem.category === 'medical' ? (newItem.supplement || '') : ''),
                        category: newItem.category
                    };

                    vocabData.push(item);
                    if (newItem.starred) { addStar(id, false); starredApplied++; }
                    addedCount++;
                });

                saveAndRender();
                alert(`${addedCount}ê°œì˜ ë‹¨ì–´ ì¶”ê°€ë¨ / ${skipCount}ê°œ ì¤‘ë³µ ê±´ë„ˆëœ€
â­ ê´€ì‹¬ ë‹¨ì–´ ë°˜ì˜: ${starredApplied}ê°œ
í˜„ì¬ ì´ ë‹¨ì–´ ìˆ˜: ${vocabData.length}ê°œ`);
            } catch (err) {
                alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message);
            }
            fileInput.value = '';
        };
        reader.readAsText(file);
    });

    // ===== íƒ­/ëª¨ë“œ =====
    function switchTab(tabName) {
        currentTab = tabName;

        document.querySelectorAll('.tab-btn').forEach(btn =>
            btn.classList.toggle('active', btn.dataset.tab === tabName)
        );

        // ê´€ì‹¬ ë‹¨ì–´ íƒ­ì€ ì…ë ¥ ì¹´í…Œê³ ë¦¬ë¥¼ ë°”ê¾¸ì§€ ì•ŠìŒ
        if (tabName !== 'star') categorySelect.value = tabName;

        // ê´€ì‹¬ ë‹¨ì–´ íƒ­ì—ì„œëŠ” ì¼ê´„ ì…ë ¥(ê°€ì´ë“œ)ì´ í˜¼ë™ë  ìˆ˜ ìˆì–´ ìë™ìœ¼ë¡œ ê°œë³„ ì…ë ¥ìœ¼ë¡œ ì „í™˜
        if (tabName === 'star' && currentMode === 'bulk') switchMode('individual');

        updateUI();
        renderList();
    }
    window.switchTab = switchTab;

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('mode-indiv').classList.toggle('active', mode === 'individual');
        document.getElementById('mode-bulk').classList.toggle('active', mode === 'bulk');
        document.getElementById('individual-area').style.display = (mode === 'individual') ? 'block' : 'none';
        document.getElementById('bulk-area').style.display = (mode === 'bulk') ? 'block' : 'none';

        if (mode === 'bulk') {
            const bulkTab = (currentTab === 'star') ? categorySelect.value : currentTab;
            const format = bulkTab === 'medical'
                ? "ë‹¨ì–´ @@ ëœ» @@ ë°œìŒ @@ íŒŒìƒì–´ @@ ì˜ˆì‹œ @@ ë³´ì¶©ì„¤ëª…"
                : "ë‹¨ì–´ @@ ëœ» @@ ë°œìŒ @@ íŒŒìƒì–´ @@ ì˜ˆì‹œ";

            bulkGuideText.innerHTML =
                `í˜„ì¬ ì„¹ì…˜: <b>${bulkTab === 'medical' ? 'ğŸ¥ ì˜í•™ ìš©ì–´' : 'ğŸ ì¼ë°˜ ë‹¨ì–´'}</b><br>` +
                `í˜•ì‹: <b>${format}</b><br>` +
                `<small>(í•­ëª© ê°„ <b>@@</b> êµ¬ë¶„, ê°•ì¡°ëŠ” <b>==ë‹¨ì–´==</b> ê¸°í˜¸ ì‚¬ìš©)</small>`;

            bulkInput.placeholder = `ì˜ˆì‹œ: EEG @@ ë‡Œì „ì¦ @@ /ËŒiË.iË.ËˆdÊ’iË/ @@ n. electroencephalogram @@ ==EEG== signals are filtered. @@ ë‡Œì˜ ì „ê¸°ì  í™œë™ ì¸¡ì • ë„êµ¬`;
            addBtn.innerText = 'ì¼ê´„ íŒŒì‹± ë° ì¶”ê°€';
        } else {
            addBtn.innerText = editingId ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì¶”ê°€í•˜ê¸°';
        }
    }
    window.switchMode = switchMode;

    function updateUI() {
        const isMedical = categorySelect.value === 'medical';
        supplementInput.style.display = isMedical ? 'block' : 'none';
        addBtn.style.backgroundColor = isMedical ? 'var(--primary-medical)' : 'var(--primary-general)';

        // ê´€ì‹¬ íƒ­ì—ì„œëŠ” ë¦¬ìŠ¤íŠ¸ë§Œ ê´€ì‹¬ ë‹¨ì–´ë¡œ ë³´ì—¬ì£¼ë˜, ì…ë ¥ UIëŠ” ê¸°ì¡´ëŒ€ë¡œ ìœ ì§€
        if (currentMode === 'bulk') switchMode('bulk');
    }

    // ===== ì¶”ê°€/ìˆ˜ì • =====
    addBtn.addEventListener('click', () => {
        if (currentMode === 'bulk') {
            const lines = bulkInput.value.split(/\r?\n/).filter(l => l.trim());
            let added = 0; let skipped = 0;

            const bulkTab = (currentTab === 'star') ? categorySelect.value : currentTab;

            lines.forEach(line => {
                const p = line.split('@@').map(x => x.trim());
                if (p[0] && p[1]) {
                    if (checkDuplicate(p[0], bulkTab)) { skipped++; }
                    else {
                        vocabData.unshift({
                            id: Date.now() + Math.random(),
                            word: p[0],
                            meaning: p[1],
                            pronunciation: p[2] || '',
                            derivative: p[3] || '',
                            example: p[4] || '',
                            supplement: (bulkTab === 'medical' ? (p[5] || '') : ''),
                            category: bulkTab
                        });
                        added++;
                    }
                }
            });

            bulkInput.value = '';
            alert(`${added}ê°œì˜ ë‹¨ì–´ ì¶”ê°€ ì™„ë£Œ, ${skipped}ê°œì˜ ì¤‘ë³µ ë‹¨ì–´ ê±´ë„ˆëœ€.`);
        } else {
            const word = wordInput.value.trim(),
                  meaning = meaningInput.value.trim(),
                  pronunciation = pronunciationInput.value.trim();

            if (!word || !meaning) return;

            if (!editingId && checkDuplicate(word, categorySelect.value)) {
                alert("ì´ë¯¸ ë™ì¼í•œ ì¹´í…Œê³ ë¦¬ì— ë“±ë¡ëœ ë‹¨ì–´ì…ë‹ˆë‹¤.");
                return;
            }

            const item = {
                word,
                meaning,
                pronunciation,
                derivative: derivativeInput.value.trim(),
                example: exampleInput.value.trim(),
                supplement: categorySelect.value === 'medical' ? supplementInput.value.trim() : '',
                category: categorySelect.value
            };

            if (editingId) {
                vocabData = vocabData.map(i => i.id === editingId ? { ...i, ...item } : i);
                editingId = null;
                cancelBtn.style.display = 'none';
            } else {
                vocabData.unshift({ id: Date.now(), ...item });
            }

            clearInputs();
        }

        saveAndRender();
    });

    cancelBtn.addEventListener('click', () => {
        editingId = null;
        cancelBtn.style.display = 'none';
        clearInputs();
        addBtn.innerText = 'ì¶”ê°€í•˜ê¸°';
    });

    // ===== í‘œì‹œ =====
    function applyStyle(text) {
        if (!text) return '';
        let safe = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return safe.replace(/\=\=([^\=]+)\=\=/g, '<span class="emphasis">$1</span>');
    }

    function renderList() {
        vocabList.innerHTML = '';

        const term = searchInput.value.toLowerCase();
        const target = searchTarget.value;
        const isSearching = term.length > 0;
        const isStarTab = currentTab === 'star';

        searchClear.style.display = isSearching ? 'block' : 'none';

        const filtered = vocabData.filter(i => {
            if (isStarTab && !isStarred(i.id)) return false;

            // ê²€ìƒ‰ ì¤‘ì´ ì•„ë‹ˆë©´: íƒ­ì— ë§ì¶° í•„í„° (ê´€ì‹¬ íƒ­ ì œì™¸)
            if (!isSearching && !isStarTab && i.category !== currentTab) return false;
            if (!isSearching) return true;

            const inWord = (i.word + (i.derivative || "")).toLowerCase().includes(term);
            const inMeaning = (i.meaning || "").toLowerCase().includes(term);
            const inSupp = (i.supplement || "").toLowerCase().includes(term);
            const inExample = (i.example || "").toLowerCase().includes(term);

            if (target === 'word') return inWord;
            if (target === 'meaning') return inMeaning;
            if (target === 'supp') return inSupp;
            return inWord || inMeaning || inSupp || inExample;
        });

        filtered.forEach(item => {
            const li = document.createElement('li');
            li.className = `vocab-item item-${item.category}`;

            const showBadge = isSearching || isStarTab;
            const starOn = isStarred(item.id);

            li.innerHTML = `
                ${showBadge ? `<span class="cat-badge">${item.category === 'medical' ? 'ì˜í•™' : 'ì¼ë°˜'}</span>` : ''}
                <div class="word-group">
                    <span class="word">${item.word}</span>
                    ${item.pronunciation ? `<span class="pronunciation">[${item.pronunciation}]</span>` : ''}
                    <span class="meaning">${item.meaning}</span>
                </div>
                <div class="action-btns">
                    <button class="icon-btn star-btn ${starOn ? 'on' : ''}" title="ê´€ì‹¬ ë‹¨ì–´" onclick="toggleStar(${item.id})">${starOn ? 'â­' : 'â˜†'}</button>
                    <button class="icon-btn" title="ìˆ˜ì •" onclick="startEdit(${item.id})">âœï¸</button>
                    <button class="icon-btn" title="ì‚­ì œ" onclick="deleteWord(${item.id})">ğŸ—‘ï¸</button>
                </div>
                ${item.derivative ? `<div class="deriv-text">íŒŒìƒ: ${item.derivative}</div>` : ''}
                ${item.example ? `<div class="example-box">${applyStyle(item.example)}</div>` : ''}
                ${item.supplement ? `<div class="supp-box">ğŸ’¡ ${applyStyle(item.supplement)}</div>` : ''}
            `;
            vocabList.appendChild(li);
        });
    }

    // ===== ê²€ìƒ‰ =====
    searchClear.addEventListener('click', () => {
        searchInput.value = '';
        renderList();
        searchInput.focus();
    });

    searchInput.addEventListener('input', renderList);
    searchTarget.addEventListener('change', renderList);

    // ===== í¸ì§‘/ì‚­ì œ =====
    function clearInputs() { [wordInput, pronunciationInput, meaningInput, derivativeInput, exampleInput, supplementInput].forEach(el => el.value = ''); }

    window.startEdit = function(id) {
        const item = vocabData.find(i => i.id === id);
        if (!item) return;

        editingId = id;
        switchMode('individual');

        wordInput.value = item.word;
        pronunciationInput.value = item.pronunciation || '';
        meaningInput.value = item.meaning;
        derivativeInput.value = item.derivative || '';
        exampleInput.value = item.example || '';
        supplementInput.value = item.supplement || '';
        categorySelect.value = item.category;

        updateUI();
        cancelBtn.style.display = 'block';
        addBtn.innerText = 'ìˆ˜ì • ì™„ë£Œ';

        window.scrollTo(0, 0);
        closeStarModal();
    };

    window.deleteWord = function(id) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        vocabData = vocabData.filter(i => i.id !== id);
        removeStar(id);
        saveAndRender();
    };

    // ===== ê´€ì‹¬ ë‹¨ì–´(â­) =====
    window.toggleStar = function(id) {
        if (isStarred(id)) removeStar(id);
        else addStar(id, true);
        saveAndRender();
    };

    function openStarModal() {
        starModal.classList.add('open');
        starModal.setAttribute('aria-hidden', 'false');
        renderStarManager();
        setTimeout(() => starModalSearch && starModalSearch.focus(), 0);
    }

    function closeStarModal() {
        starModal.classList.remove('open');
        starModal.setAttribute('aria-hidden', 'true');
        if (starModalSearch) starModalSearch.value = '';
    }

    function moveStar(id, dir) {
        const idx = starOrder.indexOf(id);
        if (idx < 0) return;

        const newIdx = idx + dir;
        if (newIdx < 0 || newIdx >= starOrder.length) return;

        const next = [...starOrder];
        const [picked] = next.splice(idx, 1);
        next.splice(newIdx, 0, picked);
        starOrder = next;
        saveAndRender();
    }

    function renderStarManager() {
        if (!starListEl) return;

        const term = normalize(starModalSearch ? starModalSearch.value : '');
        const items = starOrder
            .map(id => vocabData.find(v => v.id === id))
            .filter(Boolean)
            .filter(v => {
                if (!term) return true;
                const hay = normalize(v.word + ' ' + (v.meaning || '') + ' ' + (v.derivative || ''));
                return hay.includes(term);
            });

        starListEl.innerHTML = '';

        if (items.length === 0) {
            const empty = document.createElement('li');
            empty.style.padding = '14px 2px';
            empty.style.color = '#777';
            empty.textContent = 'ê´€ì‹¬ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¨ì–´ ì¹´ë“œì˜ â˜† ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            starListEl.appendChild(empty);
            return;
        }

        items.forEach((v, listIndex) => {
            const li = document.createElement('li');
            li.className = 'star-row';

            li.innerHTML = `
                <span class="cat-badge" style="margin:0; ${v.category === 'medical' ? 'background: var(--primary-medical);' : 'background: var(--primary-general);'}">${v.category === 'medical' ? 'ì˜í•™' : 'ì¼ë°˜'}</span>
                <div class="star-meta">
                    <div><span class="star-word">${v.word}</span><span class="star-meaning">${v.meaning || ''}</span></div>
                    <div class="star-sub">${v.pronunciation ? `[${v.pronunciation}] ` : ''}${v.derivative ? `íŒŒìƒ: ${v.derivative}` : ''}</div>
                </div>
                <div class="star-ctrl">
                    <button class="mini-btn" title="ìœ„ë¡œ" ${listIndex === 0 ? 'disabled' : ''}>â–²</button>
                    <button class="mini-btn" title="ì•„ë˜ë¡œ" ${listIndex === items.length - 1 ? 'disabled' : ''}>â–¼</button>
                    <button class="mini-btn" title="ìˆ˜ì •">âœï¸</button>
                    <button class="mini-btn danger" title="ê´€ì‹¬ í•´ì œ">âœ–</button>
                </div>
            `;

            const buttons = li.querySelectorAll('button');
            const upBtn = buttons[0], downBtn = buttons[1], editBtn = buttons[2], delBtn = buttons[3];

            upBtn.addEventListener('click', () => moveStar(v.id, -1));
            downBtn.addEventListener('click', () => moveStar(v.id, 1));
            editBtn.addEventListener('click', () => window.startEdit(v.id));
            delBtn.addEventListener('click', () => { removeStar(v.id); saveAndRender(); });

            starListEl.appendChild(li);
        });
    }

    // ëª¨ë‹¬ ì´ë²¤íŠ¸
    if (starManageBtn) starManageBtn.addEventListener('click', openStarModal);
    if (starModalClose) starModalClose.addEventListener('click', closeStarModal);

    if (starModal) {
        starModal.addEventListener('click', (e) => {
            if (e.target === starModal) closeStarModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeStarModal();
        });
    }

    if (starClearBtn) {
        starClearBtn.addEventListener('click', () => {
            if (starOrder.length === 0) { alert('ê´€ì‹¬ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            if (confirm('ê´€ì‹¬ ë‹¨ì–´ë¥¼ ëª¨ë‘ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                starOrder = [];
                saveAndRender();
            }
        });
    }

    if (starModalSearch) starModalSearch.addEventListener('input', renderStarManager);

    // ===== ì´ˆê¸°í™” =====
    categorySelect.addEventListener('change', updateUI);
    updateUI();
    saveAndRender(); // starred í”Œë˜ê·¸/ìˆœì„œ ì •ë¦¬ + ì²« ë Œë”
</script>
</body>
</html>
